
DISTNAME = $(progname)-$(progversion)
INSTALL = install
INSTALL_PROGRAM = $(INSTALL) -p -m 755
INSTALL_SCRIPT = $(INSTALL) -p -m 755
INSTALL_DATA = $(INSTALL) -p -m 644
SHELL = /bin/sh

objs = arg_parser.o decoder.o encoder.o main.o


.PHONY : all install install-info install-man install-strip \
         uninstall uninstall-info uninstall-man \
         doc info man check dist clean distclean

all : $(progname) lziprecover

$(progname) : $(objs)
	$(CXX) $(LDFLAGS) -o $(progname) $(objs)

$(progname)_profiled : $(objs)
	$(CXX) $(LDFLAGS) -pg -o $(progname)_profiled $(objs)

lziprecover : arg_parser.o lziprecover.o
	$(CXX) $(LDFLAGS) -o lziprecover arg_parser.o lziprecover.o

main.o : main.cc
	$(CXX) $(CPPFLAGS) $(CXXFLAGS) -DPROGVERSION=\"$(progversion)\" -c -o $@ $<

lziprecover.o : lziprecover.cc
	$(CXX) $(CPPFLAGS) $(CXXFLAGS) -DPROGVERSION=\"$(progversion)\" -c -o $@ $<

%.o : %.cc
	$(CXX) $(CPPFLAGS) $(CXXFLAGS) -c -o $@ $<

$(objs)       : Makefile
arg_parser.o  : arg_parser.h
decoder.o     : lzip.h decoder.h
encoder.o     : lzip.h encoder.h
main.o        : arg_parser.h lzip.h decoder.h encoder.h
lziprecover.o : arg_parser.h lzip.h Makefile

doc : info man

info : $(VPATH)/doc/$(progname).info

$(VPATH)/doc/$(progname).info : $(VPATH)/doc/$(progname).texinfo
	cd $(VPATH)/doc && makeinfo $(progname).texinfo

man : $(VPATH)/doc/lzdiff.1 $(VPATH)/doc/lzgrep.1 \
      $(VPATH)/doc/$(progname).1 $(VPATH)/doc/lziprecover.1

$(VPATH)/doc/lzdiff.1 : $(VPATH)/lzdiff
	help2man -o $(VPATH)/doc/lzdiff.1 --no-info $(VPATH)/lzdiff

$(VPATH)/doc/lzgrep.1 : $(VPATH)/lzgrep
	help2man -o $(VPATH)/doc/lzgrep.1 --no-info $(VPATH)/lzgrep

$(VPATH)/doc/$(progname).1 : $(progname)
	help2man -o $(VPATH)/doc/$(progname).1 ./$(progname)

$(VPATH)/doc/lziprecover.1 : lziprecover
	help2man -o $(VPATH)/doc/lziprecover.1 --no-info ./lziprecover

Makefile : $(VPATH)/configure $(VPATH)/Makefile.in
	./config.status

check : all $(VPATH)/testsuite/check.sh
	@$(VPATH)/testsuite/check.sh $(VPATH)/testsuite

install : all install-info install-man
	if test ! -d $(DESTDIR)$(bindir) ; then $(INSTALL) -d $(DESTDIR)$(bindir) ; fi
	$(INSTALL_SCRIPT) $(VPATH)/lzdiff $(DESTDIR)$(bindir)/lzdiff
	$(INSTALL_SCRIPT) $(VPATH)/lzgrep $(DESTDIR)$(bindir)/lzgrep
	$(INSTALL_PROGRAM) ./$(progname) $(DESTDIR)$(bindir)/$(progname)
	$(INSTALL_PROGRAM) ./lziprecover $(DESTDIR)$(bindir)/lziprecover

install-info :
	if test ! -d $(DESTDIR)$(infodir) ; then $(INSTALL) -d $(DESTDIR)$(infodir) ; fi
	$(INSTALL_DATA) $(VPATH)/doc/$(progname).info $(DESTDIR)$(infodir)/$(progname).info
	-install-info --info-dir=$(DESTDIR)$(infodir) $(DESTDIR)$(infodir)/$(progname).info

install-man :
	if test ! -d $(DESTDIR)$(mandir)/man1 ; then $(INSTALL) -d $(DESTDIR)$(mandir)/man1 ; fi
	$(INSTALL_DATA) $(VPATH)/doc/lzdiff.1 $(DESTDIR)$(mandir)/man1/lzdiff.1
	$(INSTALL_DATA) $(VPATH)/doc/lzgrep.1 $(DESTDIR)$(mandir)/man1/lzgrep.1
	$(INSTALL_DATA) $(VPATH)/doc/$(progname).1 $(DESTDIR)$(mandir)/man1/$(progname).1
	$(INSTALL_DATA) $(VPATH)/doc/lziprecover.1 $(DESTDIR)$(mandir)/man1/lziprecover.1

install-strip : all
	$(MAKE) INSTALL_PROGRAM='$(INSTALL_PROGRAM) -s' install

uninstall : uninstall-info uninstall-man
	-rm -f $(DESTDIR)$(bindir)/lzdiff
	-rm -f $(DESTDIR)$(bindir)/lzgrep
	-rm -f $(DESTDIR)$(bindir)/$(progname)
	-rm -f $(DESTDIR)$(bindir)/lziprecover

uninstall-info :
	-install-info --info-dir=$(DESTDIR)$(infodir) --remove $(DESTDIR)$(infodir)/$(progname).info
	-rm -f $(DESTDIR)$(infodir)/$(progname).info

uninstall-man :
	-rm -f $(DESTDIR)$(mandir)/man1/$(progname).1

dist :
	ln -sf $(VPATH) $(DISTNAME)
	tar -cvf $(DISTNAME).tar \
	  $(DISTNAME)/AUTHORS \
	  $(DISTNAME)/COPYING \
	  $(DISTNAME)/ChangeLog \
	  $(DISTNAME)/INSTALL \
	  $(DISTNAME)/Makefile.in \
	  $(DISTNAME)/NEWS \
	  $(DISTNAME)/README \
	  $(DISTNAME)/configure \
	  $(DISTNAME)/doc/lzdiff.1 \
	  $(DISTNAME)/doc/lzgrep.1 \
	  $(DISTNAME)/doc/$(progname).1 \
	  $(DISTNAME)/doc/$(progname).info \
	  $(DISTNAME)/doc/$(progname).texinfo \
	  $(DISTNAME)/doc/lziprecover.1 \
	  $(DISTNAME)/lzdiff \
	  $(DISTNAME)/lzgrep \
	  $(DISTNAME)/testsuite/COPYING.lz \
	  $(DISTNAME)/testsuite/check.sh \
	  $(DISTNAME)/testsuite/unzcrash.cc \
	  $(DISTNAME)/*.h \
	  $(DISTNAME)/*.cc
	rm -f $(DISTNAME)
	lzip -v -9 $(DISTNAME).tar

clean :
	-rm -f $(progname) $(progname)_profiled $(objs)
	-rm -f lziprecover lziprecover.o

distclean : clean
	-rm -f Makefile config.status *.tar *.tar.lz
